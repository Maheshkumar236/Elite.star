import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signOut,
  RecaptchaVerifier,
  signInWithPhoneNumber,
  signInWithCustomToken,
  signInAnonymously
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  arrayUnion,
  getDoc
} from 'firebase/firestore';
import { 
  Trophy, 
  Gamepad2, 
  Bell, 
  Settings as GearIcon, 
  ShieldCheck, 
  UserCheck, 
  Mail, 
  Lock, 
  Wallet, 
  Zap, 
  Award, 
  Camera, 
  Moon, 
  Sun, 
  ShieldAlert, 
  LogOut, 
  ChevronRight, 
  Key, 
  Target, 
  Clock, 
  Crown, 
  Medal, 
  ExternalLink,
  Trash2,
  MinusCircle,
  PlusCircle,
  PlayCircle,
  CheckCircle,
  XCircle,
  Image as ImageIcon,
  Sparkles,
  Bot,
  MessageSquare,
  Users,
  QrCode,
  Flame,
  TrendingUp,
  Send,
  Gift,
  Star,
  Copy
} from 'lucide-react';

// ==========================================
// CONFIGURATION (Aapke Screenshot Se Li Gayi)
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyDPChNIAQz0gEmsuDFpACl0XvWm-DNcf2k",
  authDomain: "eliteweb-5b512.firebaseapp.com",
  projectId: "eliteweb-5b512",
  storageBucket: "eliteweb-5b512.firebasestorage.app",
  messagingSenderId: "474751993215",
  appId: "1:474751993215:web:88be5ffccdd88651cf464a",
  measurementId: "G-9HZY4280CY"
};

const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);

// Rule 1: Sanitize appId
const appId = (typeof __app_id !== 'undefined' ? __app_id : 'ff-tournament-pro-final').replace(/\//g, '_');
const apiKey = ""; // Provided by runtime

const callGemini = async (prompt, systemInstruction = "You are a helpful AI.") => {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      })
    });
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI offline.";
  } catch (e) { return "Connection failed."; }
};

// ==========================================
// HELPER COMPONENTS
// ==========================================

const Toast = ({ message, type, onClose }) => (
  <div className={`fixed top-10 left-1/2 -translate-x-1/2 z-[200] px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-3 border animate-in slide-in-from-top-4 duration-300 ${
    type === 'error' ? 'bg-red-600 border-red-400' : 'bg-orange-600 border-orange-400'
  }`}>
    {type === 'error' ? <XCircle className="text-white" /> : <CheckCircle className="text-white" />}
    <span className="text-white font-black uppercase text-xs italic">{String(message)}</span>
    <button onClick={onClose} className="ml-4 opacity-50 hover:opacity-100 text-white font-bold">X</button>
  </div>
);

const NavBtn = ({ active, icon, label, onClick }) => (
  <button onClick={onClick} className={`flex flex-col items-center gap-1 transition-all duration-300 relative shrink-0 ${active ? 'text-orange-500 -translate-y-2 scale-110' : 'text-gray-500'}`}>
    {active && <div className="absolute -top-10 w-14 h-14 bg-orange-600/15 blur-2xl rounded-full" />}
    <div className={`p-2 rounded-xl transition-all ${active ? 'bg-orange-600/10' : ''}`}>
      {React.cloneElement(icon, { className: 'w-6 h-6' })}
    </div>
    <span className="text-[8px] font-black uppercase tracking-[0.1em] italic">{label}</span>
  </button>
);

// ==========================================
// MAIN APPLICATION COMPONENT
// ==========================================
export default function App() {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('home');
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [toast, setToast] = useState(null);

  // OTP Login States
  const [phone, setPhone] = useState("");
  const [otp, setOtp] = useState("");
  const [otpSent, setOtpSent] = useState(false);
  const [confirmationResult, setConfirmationResult] = useState(null);
  const [loginLoading, setLoginLoading] = useState(false);

  // Data States
  const [matches, setMatches] = useState([]);
  const [notifications, setNotifications] = useState([]);
  const [winners, setWinners] = useState([]);
  const [appConfig, setAppConfig] = useState(null);
  const [chatMessages, setChatMessages] = useState([]);
  const [payments, setPayments] = useState([]);
  const [globalAlert, setGlobalAlert] = useState(null);
  const [sessionStart] = useState(Date.now());

  // Modals & UI States
  const [isAdminUnlocked, setIsAdminUnlocked] = useState(false);
  const [isStaffUnlocked, setIsStaffUnlocked] = useState(false);
  const [showAdminModal, setShowAdminModal] = useState(false);
  const [showStaffModal, setShowStaffModal] = useState(false);
  const [showJoinModal, setShowJoinModal] = useState(false);
  const [selectedMatch, setSelectedMatch] = useState(null);
  
  const [adminTapCount, setAdminTapCount] = useState(0);
  const [staffTapCount, setStaffTapCount] = useState(0);
  const [staffSubTab, setStaffSubTab] = useState('matches');

  const [generatingBio, setGeneratingBio] = useState(false);
  const [aiStrategyData, setAiStrategyData] = useState(null);
  const [aiPredictData, setAiPredictData] = useState(null);
  const [walletAction, setWalletAction] = useState(null); 
  const chatEndRef = useRef(null);

  // --- OTP Verification Helpers ---
  const setupRecaptcha = () => {
    if (!window.recaptchaVerifier) {
      window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
        'size': 'invisible'
      });
    }
  };

  const handleSendOtp = async (e) => {
    e.preventDefault();
    if (phone.length < 10) return showMessage("Mobile number galat hai!", "error");
    setLoginLoading(true);
    setupRecaptcha();
    try {
      const confirmation = await signInWithPhoneNumber(auth, `+91${phone}`, window.recaptchaVerifier);
      setConfirmationResult(confirmation);
      setOtpSent(true);
      showMessage("OTP SMS Bhej Diya Gaya Hai!");
    } catch (err) {
      showMessage("SMS Nahi Gaya. Firebase check karein!", "error");
    }
    setLoginLoading(false);
  };

  const handleVerifyOtp = async (e) => {
    e.preventDefault();
    setLoginLoading(true);
    try {
      const result = await confirmationResult.confirm(otp);
      const newUser = result.user;
      const profileRef = doc(db, 'artifacts', appId, 'users', newUser.uid, 'profile', 'data');
      const snap = await getDoc(profileRef);
      if (!snap.exists()) {
        await setDoc(profileRef, {
          username: `Gamer_${newUser.uid.slice(0,5)}`,
          balance: 50,
          uid: newUser.uid,
          phone: newUser.phoneNumber,
          totalWins: 0,
          joinedMatches: [],
          referralCode: newUser.uid.slice(0, 6).toUpperCase(),
          xp: 10,
          referralClaimed: false
        });
      }
      showMessage("Welcome to Elite Arena!");
    } catch (err) { showMessage("OTP Galat Hai!", "error"); }
    setLoginLoading(false);
  };

  // --- Auth logic ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } 
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // --- Data Listeners ---
  useEffect(() => {
    if (!user) return;
    
    const unsubMatches = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), (snap) => setMatches(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubUser = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), (ds) => { if (ds.exists()) setUserData(ds.data()); });
    const unsubConfig = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), (ds) => { if (ds.exists()) setAppConfig(ds.data()); });
    const unsubWinners = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'winners'), (snap) => setWinners(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubNotify = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), (snap) => setNotifications(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.timestamp - a.timestamp)));
    const unsubChat = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), (snap) => setChatMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.timestamp - b.timestamp).slice(-50)));
    const unsubPayments = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'payments'), (snap) => setPayments(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp - a.timestamp)));
    const unsubAlerts = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'alerts'), (snap) => {
       const latest = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(a => a.timestamp > sessionStart).sort((a,b) => b.timestamp - a.timestamp)[0];
       if (latest) setGlobalAlert(latest);
    });

    return () => { unsubMatches(); unsubUser(); unsubConfig(); unsubWinners(); unsubNotify(); unsubChat(); unsubPayments(); unsubAlerts(); };
  }, [user, sessionStart]);

  useEffect(() => {
    if (activeTab === 'lobby') chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [chatMessages, activeTab]);

  const showMessage = (msg, type = 'success') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  };

  const handleJoinMatchAction = async (e) => {
    e.preventDefault();
    const form = e.currentTarget;
    const fd = new FormData(form);
    if (userData.balance < selectedMatch.entryFee) return showMessage("Paisa kam hai!", "error");

    try {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', selectedMatch.id), {
        joinedCount: (selectedMatch.joinedCount || 0) + 1,
        participants: arrayUnion({ uid: user.uid, gameName: fd.get('gameName'), gameUID: fd.get('gameUID') })
      });
      await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), {
        balance: Number(userData.balance) - Number(selectedMatch.entryFee),
        joinedMatches: arrayUnion(selectedMatch.id)
      });
      showMessage("Match Joined Successfully!");
      setShowJoinModal(false);
    } catch (err) { showMessage(err.message, "error"); }
  };

  const handleWalletSubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const amt = Number(fd.get('amount'));
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'payments'), {
        uid: user.uid, username: userData.username, type: walletAction, amount: amt, upiId: fd.get('upi') || '', txnId: fd.get('txnId') || '', status: 'pending', timestamp: Date.now()
    });
    showMessage(`${walletAction.toUpperCase()} request sent!`);
    setWalletAction(null);
  };

  const redeemReferral = async (e) => {
    e.preventDefault();
    const code = new FormData(e.currentTarget).get('code').trim().toUpperCase();
    if (userData.referralClaimed) return showMessage("Already claimed!", "error");
    if (code === userData.referralCode) return showMessage("Apna hi code? Haha!", "error");

    const usersRef = collection(db, 'artifacts', appId, 'users');
    const snapshot = await getDocs(usersRef);
    const referrer = snapshot.docs.find(u => u.id.toUpperCase().startsWith(code));

    if (referrer) {
        const referrerRef = doc(db, 'artifacts', appId, 'users', referrer.id, 'profile', 'data');
        const refSnap = await getDoc(referrerRef);
        if (refSnap.exists()) {
            await updateDoc(referrerRef, { balance: Number(refSnap.data().balance || 0) + 5 });
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), { balance: userData.balance + 10, referralClaimed: true });
            showMessage("Bonus Added! Dost ko ₹5 mil gaye.");
        }
    } else { showMessage("Galat Code!", "error"); }
  };

  // Level Logic
  const playerLevel = Math.floor(((userData?.joinedMatches?.length || 0) * 10 + (userData?.totalWins || 0) * 50) / 25) + 1;

  if (loading) return <div className="h-screen bg-black flex items-center justify-center text-orange-600 font-black italic animate-pulse">CONNECTING ARENA...</div>;

  // Login View with OTP
  if (!user) return (
    <div className="min-h-screen bg-[#05050a] flex flex-col items-center justify-center p-8 text-white relative">
      <div id="recaptcha-container"></div>
      <Zap className="w-16 h-16 text-orange-600 mb-6 rotate-12" />
      <h1 className="text-4xl font-black italic uppercase tracking-tighter mb-2">ELITE LOGIN</h1>
      <p className="text-gray-500 text-[10px] font-bold uppercase mb-12 italic tracking-widest">Phone OTP Verification</p>

      {!otpSent ? (
        <form onSubmit={handleSendOtp} className="w-full max-w-sm space-y-4">
           <div className="relative">
             <span className="absolute left-5 top-1/2 -translate-y-1/2 text-gray-500 font-bold">+91</span>
             <input value={phone} onChange={(e) => setPhone(e.target.value.replace(/\D/g,''))} type="tel" placeholder="Mobile Number" maxLength={10} required className="w-full bg-white/5 border border-white/10 rounded-2xl p-5 pl-14 outline-none font-bold" />
           </div>
           <button disabled={loginLoading} type="submit" className="w-full bg-orange-600 text-white font-black py-5 rounded-2xl uppercase shadow-xl">{loginLoading ? 'PROCESS...' : 'GET OTP'}</button>
        </form>
      ) : (
        <form onSubmit={handleVerifyOtp} className="w-full max-w-sm space-y-4">
           <input value={otp} onChange={(e) => setOtp(e.target.value.replace(/\D/g,''))} type="text" placeholder="6-Digit OTP" maxLength={6} required className="w-full bg-white/5 border border-white/10 rounded-2xl p-5 outline-none font-bold text-center tracking-[1em]" />
           <button disabled={loginLoading} type="submit" className="w-full bg-orange-600 text-white font-black py-5 rounded-2xl uppercase shadow-xl">VERIFY</button>
        </form>
      )}
    </div>
  );

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-[#05050a] text-white' : 'bg-[#fafafa] text-black'} pb-32`}>
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}

      <header className="fixed top-0 inset-x-0 h-16 bg-black/40 backdrop-blur-xl border-b border-white/5 flex items-center justify-between px-6 z-50">
        <div className="flex items-center gap-2">
          <Zap className="text-orange-600 w-5 h-5 fill-orange-600" />
          <h1 className="font-black italic text-lg uppercase tracking-tighter">ELITE</h1>
        </div>
        <div className="px-4 py-1.5 rounded-2xl bg-white/5 border border-white/10 flex items-center gap-2 text-xs font-black">
          <Wallet className="w-3.5 h-3.5 text-green-500" /> ₹{userData?.balance || 0}
        </div>
      </header>

      <main className="pt-24 px-6 max-w-lg mx-auto min-h-screen">
        
        {activeTab === 'home' && (
          <div className="animate-in slide-in-from-bottom-4 space-y-8 pb-10">
            <div className="relative h-52 w-full rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/5 bg-black group">
              {appConfig?.bannerLink ? (
                appConfig.bannerLink.includes('youtube') ? (
                  <iframe className="w-full h-full" src={`https://www.youtube.com/embed/${appConfig.bannerLink.split('v=')[1] || appConfig.bannerLink.split('/').pop()}`} frameBorder="0" allowFullScreen></iframe>
                ) : <img className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" src={appConfig.bannerLink} alt="Banner" />
              ) : <img className="w-full h-full object-cover" src="https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&q=80&w=800" alt="Default" />}
              <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent flex flex-col justify-end p-8">
                 <h2 className="text-2xl font-black italic uppercase text-white tracking-tighter">Elite Scrims</h2>
                 <p className="text-[10px] font-bold opacity-80 uppercase text-white tracking-[0.2em] italic">Join for Glory</p>
              </div>
            </div>

            <div className="space-y-4">
               <h4 className="font-black text-[10px] uppercase italic text-gray-500 tracking-widest flex items-center gap-2">
                 <Clock className="w-4 h-4 text-orange-500" /> LIVE MATCHES
               </h4>
               {matches.map(m => (
                 <div key={m.id} className="bg-white/5 border border-white/10 p-6 rounded-[2rem] relative border-l-4 border-l-orange-600 backdrop-blur-md shadow-2xl">
                    <div className="flex justify-between items-start mb-2">
                      <span className="text-[9px] font-black uppercase text-orange-500 bg-orange-500/10 px-3 py-1 rounded-full">{m.map}</span>
                      <span className="text-[9px] text-gray-500 font-bold italic">{m.time}</span>
                    </div>
                    <h5 className="text-xl font-black tracking-tight uppercase italic">{m.title}</h5>
                    <div className="mt-5 flex justify-between items-center">
                       <div className="flex gap-4">
                         <div className="text-[10px] font-bold text-green-500">₹{m.prizePool} PRIZE</div>
                         <div className="text-[10px] font-bold text-gray-400">{m.joinedCount}/{m.totalSlots || 48} SLOTS</div>
                       </div>
                       <button onClick={() => { setSelectedMatch(m); setShowJoinModal(true); }} className="px-6 py-2.5 rounded-xl text-[10px] font-black uppercase bg-orange-600 text-white shadow-lg active:scale-95">JOIN</button>
                    </div>
                    <button onClick={() => { setAiPredictData({ match: m.title, loading: true }); predictWinner(m); }} className="w-full mt-4 bg-blue-600/10 border border-blue-500/20 text-blue-400 py-2.5 rounded-xl font-black uppercase text-[9px] italic flex items-center justify-center gap-2 active:scale-95 transition-all">
                      <Sparkles className="w-3.5 h-3.5" /> AI Match Oracle
                    </button>
                 </div>
               ))}
            </div>

            <div className="space-y-4 pt-4 pb-12">
               <h4 className="font-black text-[10px] uppercase italic text-gray-500 tracking-widest flex items-center gap-2">
                 <Crown className="w-4 h-4 text-orange-500" /> HALL OF FAME
               </h4>
               <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar">
                  {winners.map(w => (
                    <div key={w.id} className="min-w-[180px] bg-white/5 border border-white/10 p-5 rounded-[2.5rem] text-center space-y-3 shadow-xl">
                       <img src={w.photo} className="w-24 h-24 rounded-3xl object-cover mx-auto shadow-2xl border border-white/5" alt="W" />
                       <div>
                         <p className="font-black text-[10px] uppercase truncate text-orange-500 mb-2 italic">@{w.name}</p>
                         <p className="text-[8px] text-green-400 font-bold uppercase italic tracking-tighter">#1 Champion</p>
                       </div>
                    </div>
                  ))}
               </div>
            </div>
          </div>
        )}

        {activeTab === 'match' && (
          <div className="animate-in slide-in-from-right-4 space-y-6 pb-12">
             <h2 className="text-2xl font-black italic uppercase flex items-center gap-2"><Gamepad2 className="text-orange-500" /> REGISTRATIONS</h2>
             {matches.filter(m => userData?.joinedMatches?.includes(m.id)).map(m => (
               <div key={m.id} className="bg-white/5 border border-white/10 p-6 rounded-[2.5rem] space-y-5 border-l-4 border-l-green-500 backdrop-blur-xl shadow-2xl">
                  <div className="flex justify-between items-center">
                     <h4 className="font-black text-lg uppercase italic text-orange-500">{m.title}</h4>
                     <span className="text-[10px] font-black text-gray-500">{m.time}</span>
                  </div>
                  <div className="p-5 bg-black/50 border border-white/5 rounded-3xl space-y-4 shadow-inner">
                     <div className="flex justify-between items-center text-xs">
                        <span className="text-gray-400 uppercase">Room ID</span>
                        <span className="font-black text-white font-mono select-all tracking-wider">{m.roomId || "WAITING..."}</span>
                     </div>
                     <div className="flex justify-between items-center text-xs">
                        <span className="text-gray-400 uppercase">Password</span>
                        <span className="font-black text-white font-mono select-all tracking-wider">{m.roomPass || "WAITING..."}</span>
                     </div>
                  </div>
                  <button onClick={() => setAiStrategyData({ map: m.map, loading: true })} className="w-full bg-purple-600/20 border border-purple-500/30 text-purple-400 py-3 rounded-2xl font-black uppercase text-[10px] italic flex items-center justify-center gap-2 active:scale-95 transition-all"><Bot className="w-4 h-4" /> Ask AI Coach ✨</button>
               </div>
             ))}
          </div>
        )}

        {activeTab === 'lobby' && (
          <div className="animate-in slide-in-from-left-4 flex flex-col h-[75vh]">
            <h2 className="text-2xl font-black italic uppercase flex items-center gap-2 mb-4 shrink-0"><MessageSquare className="text-orange-500" /> GLOBAL LOBBY</h2>
            <div className="flex-1 bg-black/40 border border-white/5 rounded-[2.5rem] p-4 flex flex-col overflow-hidden backdrop-blur-md shadow-2xl">
              <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4 px-2">
                {chatMessages.map(msg => (
                  <div key={msg.id} className={`flex items-end gap-3 ${msg.uid === user.uid ? 'flex-row-reverse' : ''}`}>
                    <img src={msg.photoURL || "https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&q=80&w=100"} className="w-8 h-8 rounded-full border border-white/10" alt="Av"/>
                    <div className={`max-w-[75%] p-3 rounded-2xl ${msg.uid === user.uid ? 'bg-orange-600 text-white rounded-br-sm' : 'bg-white/10 text-gray-200 rounded-bl-sm border border-white/5'}`}>
                      {msg.uid !== user.uid && <p className="text-[8px] font-black uppercase text-orange-400 mb-1 italic">{msg.username}</p>}
                      <p className="text-xs font-medium">{msg.text}</p>
                    </div>
                  </div>
                ))}
                <div ref={chatEndRef} />
              </div>
              <form onSubmit={async (e) => {
                e.preventDefault();
                const m = e.currentTarget.msg.value;
                if (!m) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), { uid: user.uid, username: userData.username, text: m, timestamp: Date.now(), photoURL: userData.photoURL || '' });
                e.currentTarget.reset();
              }} className="mt-2 shrink-0 flex gap-2">
                <input name="msg" placeholder="Talk tactics or trash talk..." autoComplete="off" className="flex-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 outline-none text-sm text-white focus:border-orange-500 italic" />
                <button type="submit" className="bg-orange-600 p-3.5 rounded-2xl text-white active:scale-95"><Send className="w-5 h-5" /></button>
              </form>
            </div>
          </div>
        )}

        {activeTab === 'rank' && (
          <div className="animate-in slide-in-from-right-4 space-y-6 pb-20">
            <h2 className="text-2xl font-black italic uppercase flex items-center gap-2"><TrendingUp className="text-orange-500" /> LEADERBOARD</h2>
            {winners.map((w, i) => (
              <div key={w.id} className="bg-white/5 border border-white/10 p-4 rounded-[2rem] flex items-center gap-4 backdrop-blur-md shadow-xl transition-all hover:scale-105">
                <div className="w-10 h-10 bg-black/50 rounded-full flex items-center justify-center border border-white/10 shrink-0">
                  <span className="font-black text-lg text-orange-500 italic">#{i+1}</span>
                </div>
                <img src={w.photo} className="w-14 h-14 rounded-2xl object-cover border border-white/10 shrink-0" alt="Squad"/>
                <div className="flex-1 min-w-0">
                  <h5 className="font-black text-sm uppercase text-white truncate italic">{w.name}</h5>
                  <p className="text-[9px] text-green-400 font-black uppercase tracking-widest mt-0.5">Prize: ₹{w.prize || '1000+'}</p>
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'settings' && (
          <div className="space-y-6 animate-in slide-in-from-left-4 pb-12">
            <h2 className="text-2xl font-black italic uppercase flex items-center gap-2">
                <GearIcon onClick={() => setAdminTapCount(prev => (prev+1 >= 10 ? (setShowAdminModal(true),0) : prev+1))} className="text-orange-500 cursor-pointer" /> MY PROFILE
            </h2>

            <div className="bg-white/5 p-8 rounded-[3rem] border border-white/10 space-y-8 text-center shadow-2xl relative overflow-hidden backdrop-blur-md">
               <div className="flex flex-col items-center gap-4 relative z-10">
                  <div className="relative group cursor-pointer" onClick={() => showMessage("Photo update enabled in next release!")}>
                    <img src={userData?.photoURL || "https://images.unsplash.com/photo-1618519764620-7403abdbcdc9?auto=format&fit=crop&q=80&w=200"} className="w-36 h-36 rounded-[2.8rem] object-cover border-4 border-orange-600/30 shadow-2xl" alt="P" />
                    <div className="absolute -bottom-2 -right-2 bg-orange-600 px-4 py-1.5 rounded-full text-[10px] font-black italic flex items-center gap-1 shadow-xl shadow-orange-600/20"><Star className="w-3 h-3" /> LVL {playerLevel}</div>
                  </div>
                  <div>
                    <h4 className="font-black text-3xl tracking-tighter italic uppercase text-orange-500">@{userData?.username || 'GAMER'}</h4>
                    <p className="text-[10px] text-gray-500 font-mono font-bold mt-1 tracking-[0.2em]">{userData?.phone}</p>
                  </div>
               </div>

               <div className="grid grid-cols-2 gap-4">
                  <div className="bg-black/40 p-6 rounded-[2.2rem] text-center border border-white/5 border-l-2 border-l-green-500">
                     <Medal className="w-6 h-6 text-green-500 mx-auto mb-1" />
                     <p className="text-[9px] font-black text-gray-500 uppercase italic">Wins</p>
                     <p className="text-3xl font-black italic text-green-500">{userData?.totalWins || 0}</p>
                  </div>
                  <div className="bg-black/40 p-6 rounded-[2.2rem] text-center border border-white/5 border-l-2 border-l-orange-500">
                     <Gamepad2 className="w-6 h-6 text-orange-500 mx-auto mb-1" />
                     <p className="text-[9px] font-black text-gray-500 uppercase italic">Matches</p>
                     <p className="text-3xl font-black italic text-orange-500">{userData?.joinedMatches?.length || 0}</p>
                  </div>
               </div>

               <div className="bg-white/5 border border-white/10 rounded-3xl p-6 space-y-4 shadow-xl">
                 <div className="flex items-center justify-between">
                   <h5 className="font-black text-[10px] uppercase italic text-gray-400 flex items-center gap-2"><QrCode className="w-4 h-4 text-green-500"/> WALLET</h5>
                   <span className="text-2xl font-black text-green-500 italic">₹{userData?.balance || 0}</span>
                 </div>
                 <div className="grid grid-cols-2 gap-3">
                   <button onClick={() => setWalletAction('add')} className="bg-green-600/20 text-green-500 border border-green-500/30 py-3.5 rounded-xl font-black uppercase text-[10px] italic active:scale-95 transition-all">ADD CASH</button>
                   <button onClick={() => setWalletAction('withdraw')} className="bg-red-600/20 text-red-500 border border-red-500/30 py-3.5 rounded-xl font-black uppercase text-[10px] italic active:scale-95 transition-all">WITHDRAW</button>
                 </div>
               </div>

               <div className="bg-blue-600/5 border border-blue-500/10 p-6 rounded-3xl space-y-4">
                 <div className="flex items-center justify-between">
                    <h5 className="font-black text-[10px] uppercase text-blue-400 flex items-center gap-2"><Gift className="w-4 h-4" /> REFER & EARN</h5>
                    <span className="text-xs font-black text-white bg-white/5 px-3 py-1 rounded-lg">{userData?.referralCode}</span>
                 </div>
                 {!userData?.referralClaimed && (
                    <form onSubmit={redeemReferral} className="flex gap-2">
                       <input name="code" placeholder="Enter Friend's Code" className="flex-1 bg-black/40 border border-white/10 rounded-xl px-4 py-2 text-xs italic outline-none" />
                       <button type="submit" className="bg-blue-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase text-white active:scale-95">REDEEM</button>
                    </form>
                 )}
                 <button onClick={() => { navigator.clipboard.writeText(userData?.referralCode); showMessage("Code Copied!"); }} className="w-full bg-white/5 border border-white/10 py-3 rounded-xl font-black uppercase text-[9px] italic flex items-center justify-center gap-2 active:scale-95 transition-all">
                    <Copy className="w-3.5 h-3.5"/> COPY MY CODE
                 </button>
               </div>

               <button onClick={() => generateHypeBio()} disabled={generatingBio} className="w-full bg-gradient-to-r from-orange-600 to-purple-600 text-white py-4 rounded-[2rem] font-black uppercase text-xs italic flex items-center justify-center gap-2 shadow-xl shadow-purple-600/20 active:scale-95 transition-all disabled:opacity-50">
                 <Sparkles className="w-5 h-5" /> {generatingBio ? 'CRAFTING...' : 'AI HYPE BIO ✨'}
               </button>
            </div>

            <button onClick={() => signOut(auth)} className="w-full bg-red-600/10 border border-red-600/20 text-red-500 py-7 rounded-[2.5rem] font-black uppercase tracking-widest text-[11px] italic flex items-center justify-center gap-3 active:scale-95 shadow-xl shadow-red-600/5 transition-all">
              <LogOut className="w-5 h-5" /> TERMINATE SESSION
            </button>

            <p onClick={() => setStaffTapCount(prev => prev+1 >= 5 ? (setShowStaffModal(true),0) : prev+1)} className="text-center text-[10px] text-gray-800 font-black uppercase tracking-[0.6em] py-10 cursor-pointer select-none active:opacity-40 italic">
               BUILD v1.3.0 • {isStaffUnlocked ? 'STAFF ENABLED' : 'SECURE'}
            </p>
          </div>
        )}

        {/* --- STAFF/ADMIN DECK --- */}
        {((activeTab === 'admin' && isAdminUnlocked) || (activeTab === 'staff' && isStaffUnlocked)) && (
          <div className="space-y-6 animate-in zoom-in-95 pb-20">
             <div className="flex items-center gap-3">
                <ShieldCheck className="text-orange-500 w-8 h-8" />
                <h2 className="text-2xl font-black italic uppercase text-orange-500">ADMIN CONTROL</h2>
             </div>

             <div className="flex gap-2 overflow-x-auto no-scrollbar py-2">
                {['matches', 'winners', 'notify', 'players', 'payments', 'alerts'].map(tab => (
                  <button key={tab} onClick={() => setStaffSubTab(tab)} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase italic transition-all shrink-0 ${staffSubTab === tab ? 'bg-orange-600 text-white' : 'bg-white/5 text-gray-500'}`}>
                    {tab}
                  </button>
                ))}
             </div>

             {staffSubTab === 'matches' && (
                <div className="space-y-6">
                   <div className="bg-white/5 p-6 rounded-[2.5rem] border border-white/10 space-y-4 shadow-xl">
                      <h4 className="font-black text-[10px] uppercase italic opacity-60">Add Tournament</h4>
                      <form onSubmit={async (e) => {
                        e.preventDefault();
                        const f = new FormData(e.currentTarget);
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), {
                          title: f.get('title'), map: f.get('map'), entryFee: Number(f.get('fee')),
                          prizePool: Number(f.get('prize')), time: f.get('time'), joinedCount: 0, totalSlots: 48, participants: []
                        });
                        e.currentTarget.reset(); showMessage("Tournament Added!");
                      }} className="space-y-3">
                         <input name="title" placeholder="Match Title" required className="w-full bg-black/50 p-4 rounded-xl border border-white/10 text-xs text-white" />
                         <div className="grid grid-cols-2 gap-3">
                           <input name="map" placeholder="Map" className="bg-black/50 p-4 rounded-xl border border-white/10 text-xs text-white" />
                           <input name="time" placeholder="Time" className="bg-black/50 p-4 rounded-xl border border-white/10 text-xs text-white" />
                         </div>
                         <div className="grid grid-cols-2 gap-3">
                           <input name="fee" type="number" placeholder="Entry Fee" className="bg-black/50 p-4 rounded-xl border border-white/10 text-xs text-white" />
                           <input name="prize" type="number" placeholder="Prize Pool" className="bg-black/50 p-4 rounded-xl border border-white/10 text-xs text-white" />
                         </div>
                         <button type="submit" className="w-full py-4 rounded-xl bg-orange-600 text-white font-black uppercase text-[10px] italic shadow-lg">HOST MATCH</button>
                      </form>
                   </div>
                   {matches.map(m => (
                     <div key={m.id} className="bg-white/5 p-6 rounded-[2.5rem] border border-white/10 space-y-4 shadow-xl">
                        <div className="flex justify-between items-center">
                           <p className="font-black text-[10px] uppercase italic text-orange-500">{m.title}</p>
                           <button onClick={async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', m.id)); showMessage("Deleted!"); }} className="p-2 bg-red-500/10 text-red-500 rounded-lg"><Trash2 className="w-4 h-4"/></button>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                           <input id={`rid-${m.id}`} defaultValue={m.roomId} placeholder="Room ID" className="bg-black/50 p-3 rounded-xl border border-white/10 font-bold text-[10px] text-center text-white" />
                           <input id={`rps-${m.id}`} defaultValue={m.roomPass} placeholder="Pass" className="bg-black/50 p-3 rounded-xl border border-white/10 font-bold text-[10px] text-center text-white" />
                        </div>
                        <button onClick={async () => {
                           const rid = document.getElementById(`rid-${m.id}`).value;
                           const rps = document.getElementById(`rps-${m.id}`).value;
                           await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', m.id), { roomId: rid, roomPass: rps });
                           showMessage("Saved!");
                        }} className="w-full bg-white/5 border border-white/10 py-3 rounded-xl text-[9px] font-black uppercase italic">UPDATE ROOM</button>
                     </div>
                   ))}
                </div>
             )}

             {staffSubTab === 'payments' && (
                <div className="space-y-4">
                   {payments.map(p => (
                     <div key={p.id} className="bg-white/5 border border-white/10 rounded-[2rem] p-5 space-y-3 shadow-xl">
                        <div className="flex justify-between items-center">
                           <span className={`text-[10px] font-black uppercase px-3 py-1 rounded-full ${p.type === 'add' ? 'bg-green-500/20 text-green-500' : 'bg-red-500/20 text-red-500'}`}>{p.type}</span>
                           <span className="text-[10px] font-black uppercase italic text-orange-500">{p.status}</span>
                        </div>
                        <p className="font-black text-2xl text-white italic">₹{p.amount}</p>
                        <p className="text-[10px] text-gray-400 italic">@{p.username}</p>
                        {p.status === 'pending' && (
                          <div className="grid grid-cols-2 gap-2 pt-2">
                            <button onClick={async () => {
                               const uRef = doc(db, 'artifacts', appId, 'users', p.uid, 'profile', 'data');
                               const uSnap = await getDoc(uRef);
                               const newBal = p.type === 'add' ? Number(uSnap.data().balance) + p.amount : Number(uSnap.data().balance) - p.amount;
                               await updateDoc(uRef, { balance: newBal });
                               await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', p.id), { status: 'approved' });
                               showMessage("Approved!");
                            }} className="bg-green-600 text-white py-3 rounded-xl font-black uppercase text-[9px] italic">APPROVE</button>
                            <button onClick={async () => {
                               await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', p.id), { status: 'rejected' });
                               showMessage("Rejected!");
                            }} className="bg-red-600 text-white py-3 rounded-xl font-black uppercase text-[9px] italic">REJECT</button>
                          </div>
                        )}
                     </div>
                   ))}
                </div>
             )}
          </div>
        )}

      </main>

      <nav className="fixed bottom-6 inset-x-6 h-20 bg-black/60 backdrop-blur-3xl border border-white/10 rounded-[2.5rem] flex items-center justify-around px-3 z-50 shadow-2xl">
        <NavBtn active={activeTab === 'home'} icon={<Trophy />} label="Home" onClick={() => setActiveTab('home')} />
        <NavBtn active={activeTab === 'rank'} icon={<TrendingUp />} label="Rank" onClick={() => setActiveTab('rank')} />
        <NavBtn active={activeTab === 'lobby'} icon={<MessageSquare />} label="Lobby" onClick={() => setActiveTab('lobby')} />
        <NavBtn active={activeTab === 'match'} icon={<Gamepad2 />} label="Match" onClick={() => setActiveTab('match')} />
        {isAdminUnlocked && <NavBtn active={activeTab === 'admin'} icon={<ShieldCheck className="text-orange-500" />} label="Admin" onClick={() => setActiveTab('admin')} />}
        <NavBtn active={activeTab === 'settings'} icon={<GearIcon />} label="Profile" onClick={() => setActiveTab('settings')} />
      </nav>

      {/* --- MODALS --- */}
      {showJoinModal && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-2xl flex items-center justify-center p-8 z-[100] animate-in zoom-in duration-300">
           <div className="bg-[#0c0c0c] border border-orange-600/20 p-10 rounded-[3rem] w-full max-w-sm space-y-6 shadow-2xl text-center">
              <h3 className="text-2xl font-black italic uppercase text-orange-500">Match Entry</h3>
              <p className="text-[10px] text-gray-500 font-black uppercase italic tracking-widest">{selectedMatch?.title}</p>
              <form onSubmit={handleJoinMatchAction} className="space-y-4">
                 <input name="gameName" placeholder="In-Game Name" required className="w-full bg-white/5 border border-white/10 rounded-2xl p-5 outline-none font-bold italic text-white text-xs" />
                 <input name="gameUID" placeholder="Game UID" required className="w-full bg-white/5 border border-white/10 rounded-2xl p-5 outline-none font-bold italic text-white text-xs" />
                 <div className="flex gap-4 pt-4">
                   <button type="button" onClick={() => setShowJoinModal(false)} className="flex-1 bg-white/5 py-4 rounded-2xl font-black uppercase text-[10px] italic text-white">BACK</button>
                   <button type="submit" className="flex-1 bg-orange-600 py-4 rounded-2xl font-black uppercase text-[10px] italic shadow-2xl text-white">CONFIRM</button>
                 </div>
              </form>
           </div>
        </div>
      )}

      {showAdminModal && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-2xl flex items-center justify-center p-8 z-[100] animate-in zoom-in duration-300">
           <div className="bg-[#0c0c0c] border border-orange-600/20 p-12 rounded-[3.5rem] w-full max-w-sm space-y-8 shadow-2xl">
              <ShieldCheck className="w-16 h-16 text-orange-600 mx-auto" />
              <h3 className="text-3xl font-black italic uppercase text-center italic">ADMIN VAULT</h3>
              <form onSubmit={(e) => {
                e.preventDefault();
                if (new FormData(e.currentTarget).get('pass') === "12") {
                  setIsAdminUnlocked(true); setShowAdminModal(false); setActiveTab('admin');
                } else { showMessage("Access Denied!", "error"); }
              }} className="space-y-6">
                 <input name="pass" type="password" placeholder="••••" required className="w-full bg-white/5 border border-white/10 rounded-3xl p-6 outline-none font-black text-center tracking-[1.5em] text-4xl text-white" />
                 <button type="submit" className="w-full bg-orange-600 py-5 rounded-2xl font-black uppercase text-[10px] italic text-white shadow-2xl shadow-orange-600/20">LOGIN</button>
              </form>
              <button onClick={() => setShowAdminModal(false)} className="w-full text-[10px] font-black uppercase italic text-gray-500">EXIT</button>
           </div>
        </div>
      )}

      {showStaffModal && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-2xl flex items-center justify-center p-8 z-[100] animate-in slide-in-from-bottom duration-300">
           <div className="bg-[#0a0a1a] border border-blue-500/20 p-12 rounded-[3.5rem] w-full max-w-sm space-y-6 shadow-2xl text-center">
              <UserCheck className="w-14 h-14 text-blue-500 mx-auto" />
              <h3 className="text-2xl font-black italic uppercase text-blue-500">STAFF LOGIN</h3>
              <form onSubmit={(e) => {
                e.preventDefault();
                const f = new FormData(e.currentTarget);
                if (f.get('pass') === "staff77") {
                  setIsStaffUnlocked(true); setShowStaffModal(false); setActiveTab('staff');
                } else { showMessage("Wrong Pass!", "error"); }
              }} className="space-y-3">
                 <input name="pass" type="password" placeholder="Staff Pass" required className="w-full bg-white/5 border border-white/5 rounded-2xl p-5 outline-none font-bold text-center text-xs text-white" />
                 <div className="flex gap-4 pt-4">
                   <button type="button" onClick={() => setShowStaffModal(false)} className="flex-1 bg-white/5 py-4 rounded-2xl font-black uppercase text-[10px] italic text-white">BACK</button>
                   <button type="submit" className="flex-1 bg-blue-600 py-4 rounded-2xl font-black uppercase text-[10px] italic shadow-2xl shadow-blue-600/20 text-white">VERIFY</button>
                 </div>
              </form>
           </div>
        </div>
      )}

      {aiPredictData && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-2xl flex items-center justify-center p-8 z-[100] animate-in zoom-in duration-300">
           <div className="bg-[#0c0c0c] border border-blue-600/30 p-10 rounded-[3rem] w-full max-w-sm space-y-6 shadow-2xl relative overflow-hidden text-center">
              <Bot className="w-12 h-12 text-blue-500 mx-auto" />
              <h3 className="text-xl font-black italic uppercase text-blue-400">Match Oracle</h3>
              <p className="text-[10px] text-gray-500 font-black uppercase italic tracking-widest border-b border-white/5 pb-4">{aiPredictData.match}</p>
              <div className="min-h-[100px] flex items-center justify-center">
                {aiPredictData.loading ? <p className="text-blue-400 animate-pulse italic">CALCULATING PROBABILITIES...</p> : <p className="text-sm italic text-gray-300 leading-relaxed">"{aiPredictData.text}"</p>}
              </div>
              <button onClick={() => setAiPredictData(null)} className="w-full bg-white/5 border border-white/10 py-4 rounded-2xl font-black uppercase text-[10px] italic text-white active:scale-95 transition-all">CLOSE</button>
           </div>
        </div>
      )}

      {aiStrategyData && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-2xl flex items-center justify-center p-8 z-[100] animate-in zoom-in duration-300">
           <div className="bg-[#0c0c0c] border border-purple-600/30 p-10 rounded-[3rem] w-full max-w-sm space-y-6 shadow-2xl relative overflow-hidden">
              <Bot className="w-12 h-12 text-purple-500 mx-auto" />
              <h3 className="text-xl font-black italic uppercase text-center text-purple-400">AI Tactical Coach</h3>
              <p className="text-[10px] text-center text-gray-500 font-black uppercase tracking-widest italic border-b border-white/5 pb-4">Map: {aiStrategyData.map}</p>
              <div className="min-h-[100px] flex items-center justify-center">
                {aiStrategyData.loading ? <p className="text-purple-400 animate-pulse italic">ANALYZING TERRAIN...</p> : <p className="text-sm italic text-gray-300 leading-relaxed">{aiStrategyData.text}</p>}
              </div>
              <button onClick={() => setAiStrategyData(null)} className="w-full bg-white/5 border border-white/10 py-4 rounded-2xl font-black uppercase text-[10px] italic text-white active:scale-95 transition-all">DISMISS COACH</button>
           </div>
        </div>
      )}

      {walletAction && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-2xl flex items-center justify-center p-8 z-[100] animate-in slide-in-from-bottom duration-300">
           <div className="bg-[#0c0c0c] border border-green-500/20 p-8 rounded-[3rem] w-full max-w-sm space-y-6 shadow-2xl text-center">
              <QrCode className="w-12 h-12 text-green-500 mx-auto" />
              <h3 className="text-2xl font-black italic uppercase text-white">{walletAction === 'add' ? 'Add Funds' : 'Withdraw Info'}</h3>
              <form onSubmit={handleWalletSubmit} className="space-y-4">
                 <input name="amount" type="number" placeholder="Amount (₹)" required min="10" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none font-bold italic text-white text-xs" />
                 <input name={walletAction === 'add' ? 'txnId' : 'upi'} placeholder={walletAction === 'add' ? "Transaction ID" : "Your UPI ID"} required className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none font-bold italic text-white text-xs" />
                 <div className="flex gap-4 pt-4">
                   <button type="button" onClick={() => setWalletAction(null)} className="flex-1 bg-white/5 py-4 rounded-2xl font-black uppercase text-[10px] italic text-white">CANCEL</button>
                   <button type="submit" className="flex-1 bg-green-600 py-4 rounded-2xl font-black uppercase text-[10px] italic shadow-2xl text-white">SUBMIT</button>
                 </div>
              </form>
           </div>
        </div>
      )}

      {globalAlert && (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-3xl flex items-center justify-center p-8 z-[200] animate-in zoom-in duration-500">
           <div className="bg-red-600/10 border border-red-500/50 p-10 rounded-[3rem] w-full max-w-sm space-y-6 shadow-2xl relative overflow-hidden text-center">
              <div className="absolute inset-0 bg-red-600/20 animate-pulse pointer-events-none" />
              <ShieldAlert className="w-20 h-20 text-red-500 mx-auto animate-bounce relative z-10" />
              <h3 className="text-3xl font-black italic uppercase tracking-tighter text-red-500 relative z-10">{globalAlert.title}</h3>
              <p className="text-sm font-bold text-white relative z-10 italic">{globalAlert.message}</p>
              <div className="pt-6 relative z-10">
                <button onClick={() => setGlobalAlert(null)} className="w-full bg-red-600 py-4 rounded-2xl font-black uppercase text-[10px] italic text-white active:scale-95 shadow-[0_0_30px_rgba(220,38,38,0.4)]">ACKNOWLEDGE</button>
              </div>
           </div>
        </div>
      )}

    </div>
  );
}

