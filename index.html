import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signOut,
  RecaptchaVerifier,
  signInWithPhoneNumber
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  arrayUnion,
  getDoc
} from 'firebase/firestore';
import { 
  Trophy, Gamepad2, Bell, Settings as GearIcon, ShieldCheck, UserCheck, Wallet, Zap, 
  Award, Camera, Moon, Sun, ShieldAlert, LogOut, Clock, Crown, Medal, Trash2,
  CheckCircle, XCircle, Sparkles, Bot, MessageSquare, Send, Gift, Copy, Phone, TrendingUp, Star
} from 'lucide-react';

// ==========================================
// CONFIGURATION (Aapke Screenshot Se Li Gayi)
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyDPChNIAQz0gEmsuDFpACL0XVwm-DNcf2k",
  authDomain: "eliteweb-5b512.firebaseapp.com",
  projectId: "eliteweb-5b512",
  storageBucket: "eliteweb-5b512.firebasestorage.app",
  messagingSenderId: "474751993215",
  appId: "1:474751993215:web:88be5ffccdd88651cf464a",
  measurementId: "G-9HZY4280CY"
};

const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'elite_pro_final'; 

export default function App() {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('home');
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [toast, setToast] = useState(null);

  // OTP States
  const [phone, setPhone] = useState("");
  const [otp, setOtp] = useState("");
  const [otpSent, setOtpSent] = useState(false);
  const [confirmationResult, setConfirmationResult] = useState(null);
  const [loginLoading, setLoginLoading] = useState(false);

  // Tournament & Admin
  const [matches, setMatches] = useState([]);
  const [winners, setWinners] = useState([]);
  const [chatMessages, setChatMessages] = useState([]);
  const [globalAlert, setGlobalAlert] = useState(null);
  const [isAdminUnlocked, setIsAdminUnlocked] = useState(false);
  const [showAdminModal, setShowAdminModal] = useState(false);
  const [showJoinModal, setShowJoinModal] = useState(false);
  const [selectedMatch, setSelectedMatch] = useState(null);
  const [adminTapCount, setAdminTapCount] = useState(0);

  const showMessage = (msg, type = 'success') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  };

  // --- OTP Logic ---
  const setupRecaptcha = () => {
    if (!window.recaptchaVerifier) {
      window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
        'size': 'invisible'
      });
    }
  };

  const handleSendOtp = async (e) => {
    e.preventDefault();
    if (phone.length < 10) return showMessage("Sahi number dalein!", "error");
    setLoginLoading(true);
    setupRecaptcha();
    try {
      const confirmation = await signInWithPhoneNumber(auth, `+91${phone}`, window.recaptchaVerifier);
      setConfirmationResult(confirmation);
      setOtpSent(true);
      showMessage("OTP Bhej Diya!");
    } catch (err) {
      showMessage("SMS Nahi Gaya! SMS limit check karein.", "error");
    }
    setLoginLoading(false);
  };

  const handleVerifyOtp = async (e) => {
    e.preventDefault();
    setLoginLoading(true);
    try {
      const result = await confirmationResult.confirm(otp);
      const newUser = result.user;
      const profileRef = doc(db, 'artifacts', appId, 'users', newUser.uid, 'profile', 'data');
      const snap = await getDoc(profileRef);
      if (!snap.exists()) {
        await setDoc(profileRef, {
          username: `Gamer_${newUser.uid.slice(0,5)}`,
          balance: 50,
          uid: newUser.uid,
          phone: newUser.phoneNumber,
          totalWins: 0,
          joinedMatches: [],
          referralCode: newUser.uid.slice(0, 6).toUpperCase(),
          xp: 10
        });
      }
    } catch (err) { showMessage("OTP Galat Hai!", "error"); }
    setLoginLoading(false);
  };

  // --- Listeners ---
  useEffect(() => {
    const unsubAuth = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
    return () => unsubAuth();
  }, []);

  useEffect(() => {
    if (!user) return;
    const unsubM = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), (snap) => setMatches(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubU = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), (ds) => { if (ds.exists()) setUserData(ds.data()); });
    const unsubC = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), (snap) => setChatMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.timestamp - b.timestamp).slice(-30)));
    const unsubA = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'alerts'), (snap) => {
       const latest = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp)[0];
       if (latest && latest.timestamp > Date.now() - 300000) setGlobalAlert(latest);
    });
    return () => { unsubM(); unsubU(); unsubC(); unsubA(); };
  }, [user]);

  if (loading) return <div className="h-screen bg-black flex items-center justify-center text-orange-600 font-black italic animate-pulse">ELITE ARENA...</div>;

  if (!user) return (
    <div className="min-h-screen bg-[#05050a] flex flex-col items-center justify-center p-8 text-white text-center">
      <div id="recaptcha-container"></div>
      <Zap className="w-16 h-16 text-orange-600 mx-auto mb-6" />
      <h1 className="text-4xl font-black italic uppercase">ELITE LOGIN</h1>
      {!otpSent ? (
        <form onSubmit={handleSendOtp} className="w-full max-w-sm space-y-4">
           <input value={phone} onChange={(e) => setPhone(e.target.value)} type="tel" placeholder="Mobile Number" maxLength={10} required className="w-full bg-white/5 border border-white/10 rounded-2xl p-5 outline-none font-bold" />
           <button type="submit" className="w-full bg-orange-600 py-5 rounded-2xl font-black">{loginLoading ? 'PROCESS...' : 'GET OTP'}</button>
        </form>
      ) : (
        <form onSubmit={handleVerifyOtp} className="w-full max-w-sm space-y-4">
           <input value={otp} onChange={(e) => setOtp(e.target.value)} type="text" placeholder="6-Digit OTP" required className="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-center tracking-[1em]" />
           <button type="submit" className="w-full bg-orange-600 py-5 rounded-2xl font-black">VERIFY</button>
        </form>
      )}
    </div>
  );

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-[#05050a] text-white' : 'bg-white text-black'} pb-32`}>
      {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}
      
      <header className="fixed top-0 inset-x-0 h-16 bg-black/40 backdrop-blur-xl border-b border-white/5 flex items-center justify-between px-6 z-50">
        <h1 className="font-black italic text-lg uppercase text-orange-600">ELITE PRO</h1>
        <div className="px-4 py-1.5 rounded-2xl bg-white/5 border border-white/10 flex items-center gap-2 text-xs font-black">
          <Wallet className="w-3.5 h-3.5 text-green-500" /> ₹{userData?.balance || 0}
        </div>
      </header>

      <main className="pt-24 px-6 max-w-lg mx-auto">
        {activeTab === 'home' && (
          <div className="space-y-6 animate-in slide-in-from-bottom-4">
             {matches.map(m => (
               <div key={m.id} className="bg-white/5 border border-white/10 p-6 rounded-[2rem] border-l-4 border-l-orange-600">
                  <h5 className="text-xl font-black italic uppercase">{m.title}</h5>
                  <div className="mt-4 flex justify-between items-center text-[10px] font-bold">
                     <span className="text-green-500">₹{m.prizePool} PRIZE</span>
                     <button onClick={() => { setSelectedMatch(m); setShowJoinModal(true); }} className="px-6 py-2 bg-orange-600 rounded-xl text-white">JOIN</button>
                  </div>
               </div>
             ))}
          </div>
        )}

        {activeTab === 'settings' && (
          <div className="space-y-6 pb-12 animate-in slide-in-from-left-4">
            <h2 onClick={() => setAdminTapCount(prev => prev+1 >= 10 ? (setShowAdminModal(true),0) : prev+1)} className="text-2xl font-black italic uppercase flex items-center gap-2">
                <GearIcon className="text-orange-500" /> PROFILE
            </h2>
            <div className="bg-white/5 p-8 rounded-[3rem] border border-white/10 text-center space-y-4">
               <img src={userData?.photoURL || "https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&q=80&w=200"} className="w-32 h-32 rounded-3xl mx-auto border-4 border-orange-600/20" alt="P" />
               <h4 className="font-black text-2xl text-orange-500">@{userData?.username}</h4>
               <p className="text-xs text-gray-500">Level: {Math.floor((userData?.xp || 0) / 10)}</p>
               <button onClick={() => signOut(auth)} className="w-full bg-red-600/10 text-red-500 py-4 rounded-2xl font-black">LOGOUT</button>
            </div>
          </div>
        )}
      </main>

      <nav className="fixed bottom-6 inset-x-6 h-20 bg-black/60 backdrop-blur-3xl border border-white/10 rounded-[2.5rem] flex items-center justify-around px-3 z-50">
        <NavBtn active={activeTab === 'home'} icon={<Trophy />} label="Home" onClick={() => setActiveTab('home')} />
        <NavBtn active={activeTab === 'lobby'} icon={<MessageSquare />} label="Lobby" onClick={() => setActiveTab('lobby')} />
        <NavBtn active={activeTab === 'settings'} icon={<GearIcon />} label="Profile" onClick={() => setActiveTab('settings')} />
      </nav>

      {showJoinModal && (
        <div className="fixed inset-0 bg-black/95 flex items-center justify-center p-8 z-[100]">
           <form onSubmit={async (e) => {
              e.preventDefault();
              const fd = new FormData(e.currentTarget);
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', selectedMatch.id), {
                joinedCount: (selectedMatch.joinedCount || 0) + 1,
                participants: arrayUnion({ uid: user.uid, gameName: fd.get('gameName'), gameUID: fd.get('gameUID') })
              });
              await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), {
                balance: userData.balance - selectedMatch.entryFee,
                joinedMatches: arrayUnion(selectedMatch.id)
              });
              setShowJoinModal(false); showMessage("Joined!");
           }} className="bg-[#0c0c0c] border border-orange-600/20 p-10 rounded-[3rem] w-full max-w-sm space-y-4">
              <input name="gameName" placeholder="IGN" required className="w-full bg-white/5 p-4 rounded-xl text-white outline-none" />
              <input name="gameUID" placeholder="UID" required className="w-full bg-white/5 p-4 rounded-xl text-white outline-none" />
              <button type="submit" className="w-full bg-orange-600 py-4 rounded-xl font-black text-white">CONFIRM</button>
              <button type="button" onClick={() => setShowJoinModal(false)} className="w-full text-gray-500 font-bold">BACK</button>
           </form>
        </div>
      )}
    </div>
  );
}

const Toast = ({ message, type, onClose }) => (
  <div className={`fixed top-10 left-1/2 -translate-x-1/2 z-[200] px-6 py-4 rounded-3xl shadow-2xl bg-orange-600 text-white font-black italic text-xs animate-in slide-in-from-top-4`}>
    {String(message)}
  </div>
);

const NavBtn = ({ active, icon, label, onClick }) => (
  <button onClick={onClick} className={`flex flex-col items-center gap-1 ${active ? 'text-orange-500 scale-110' : 'text-gray-500'}`}>
    {React.cloneElement(icon, { className: 'w-6 h-6' })}
    <span className="text-[8px] font-black uppercase italic">{label}</span>
  </button>
);

